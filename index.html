<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ourochest Master</title>
    <style>
        :root {
            --bg: #0b0d12;
            --panel: #161923;
            --border: #2a2e3f;
            --text-main: #eceff4;
            --text-dim: #94a3b8;
            
            /* Colores */
            --blue: #4f76cc;      
            --green: #48bfa6;     
            --turquoise: #2dc4d9; 
            --yellow: #eeb846;    
            --orange: #f0833a;    
            --red: #e04f5f;       
            
            --cell-bg: #202433;
            --hover: #2c3245;
            --gold: #ffd700;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* HEADER RESPONSIVO (TUS CAMBIOS) */
        header {
            background-color: var(--panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-shrink: 0;
            z-index: 10;
            height: 60px;
            transition: all 0.3s ease;
        }

        .logo { font-weight: 800; font-size: 1.2rem; letter-spacing: 1px; color: var(--gold); text-transform: uppercase; white-space: nowrap; }
        .logo span { color: white; margin-right: 2px; font-weight: 400; opacity: 0.9; }

        .controls { display: flex; gap: 10px; align-items: center; }

        .nav-btn {
            background: transparent; color: var(--text-dim); border: 1px solid transparent;
            padding: 6px 12px; cursor: pointer; border-radius: 4px; font-weight: 600; font-size: 0.9rem;
            white-space: nowrap;
        }
        .nav-btn:hover { color: white; }
        .nav-btn.active { background: #222; color: var(--gold); border-color: var(--border); }

        select { background: #111; color: white; border: 1px solid #333; padding: 5px; border-radius: 4px; font-size: 0.85rem;}

        /* MEDIA QUERY: MÓVIL (TUS CAMBIOS) */
        @media (max-width: 768px) {
            header {
                height: auto;
                flex-direction: column;
                padding: 10px;
                gap: 10px;
            }
            .controls {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            .nav-btn {
                font-size: 0.8rem;
                padding: 8px 10px;
                flex: 1 1 auto;
                text-align: center;
            }
            select { max-width: 80px; }
        }

        /* MAIN */
        #main-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .view-section { display: none; width: 100%; max-width: 1200px; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }

        /* GRID STYLES RESPONSIVOS */
        .grid-wrapper {
            display: grid;
            grid-template-columns: 20px repeat(5, 50px);
            grid-template-rows: 20px repeat(5, 50px);
            gap: 4px; margin-bottom: 15px;
            justify-content: center;
        }
        
        @media (max-width: 400px) {
            .grid-wrapper {
                grid-template-columns: 15px repeat(5, 40px);
                grid-template-rows: 15px repeat(5, 40px);
            }
            .cell { width: 40px; height: 40px; font-size: 1rem; }
        }

        .coord-header { display: flex; justify-content: center; align-items: center; font-size: 0.8rem; color: var(--text-dim); font-weight: bold; }
        .cell {
            width: 50px; height: 50px; background-color: var(--cell-bg); border-radius: 6px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; font-size: 1.2rem; font-weight: bold;
            position: relative; transition: transform 0.1s;
        }
        
        @media (max-width: 400px) {
             .cell { width: 40px; height: 40px; }
        }

        .cell:hover { background: var(--hover); transform: scale(1.05); z-index: 2; }
        
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; border: 2px solid var(--red) !important; }

        /* COLORES */
        .cell.revealed { cursor: default; transform: none; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
        .cell.blue { border: 2px solid var(--blue); color: var(--blue); background: rgba(79, 118, 204, 0.15); }
        .cell.green { border: 2px solid var(--green); color: var(--green); background: rgba(72, 191, 166, 0.15); }
        .cell.turquoise { border: 2px solid var(--turquoise); color: var(--turquoise); background: rgba(45, 196, 217, 0.15); }
        .cell.yellow { border: 2px solid var(--yellow); color: var(--yellow); background: rgba(238, 184, 70, 0.15); }
        .cell.orange { border: 2px solid var(--orange); color: var(--orange); background: rgba(240, 131, 58, 0.15); }
        .cell.red { background: var(--red); color: white; box-shadow: 0 0 15px var(--red); border: none; }

        /* LOG */
        .log-box {
            width: 100%; height: 320px; background: #111; border: 1px solid #333; border-radius: 6px;
            overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px;
        }
        .log-entry {
            display: grid; grid-template-columns: 30px 1fr auto; align-items: center; gap: 10px;
            padding: 10px; border-radius: 6px; border-left: 5px solid #555;
            font-size: 0.9rem; animation: slideIn 0.2s; background: #1a1a1a;
        }
        .log-num { color: rgba(255,255,255,0.7); font-weight: bold; font-size: 0.9rem; text-align: center; }
        .log-pts { font-weight: bold; color: white; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; }
        .hint-text { font-size: 0.85em; opacity: 0.9; display: block; margin-top: 4px; color: #ddd; }
        
        .le-blue { border-color: var(--blue); background: rgba(79, 118, 204, 0.15); }
        .le-green { border-color: var(--green); background: rgba(72, 191, 166, 0.15); }
        .le-turq { border-color: var(--turquoise); background: rgba(45, 196, 217, 0.15); }
        .le-yell { border-color: var(--yellow); background: rgba(238, 184, 70, 0.15); }
        .le-orng { border-color: var(--orange); background: rgba(240, 131, 58, 0.15); }
        .le-red { border-color: var(--red); background: rgba(224, 79, 95, 0.25); }
        
        .summary-card {
            background: linear-gradient(135deg, #ffd70022, #000); border: 1px solid var(--gold);
            text-align: center; padding: 15px; color: white; margin-top: 10px;
        }

        /* ESTILOS DE LA GUÍA (Necesarios para que se vea bien) */
        .guide-container { max-width: 900px; width: 100%; margin: 0 auto; padding-bottom: 50px; }
        .guide-section { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .section-header { font-size: 1.2rem; color: var(--gold); font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .flow-step { display: flex; gap: 20px; margin-bottom: 25px; border-bottom: 1px dashed #333; padding-bottom: 20px; flex-wrap: wrap; }
        .flow-step:last-child { border-bottom: none; }
        
        .mini-grid { display: grid; grid-template-columns: repeat(5, 25px); grid-template-rows: repeat(5, 25px); gap: 2px; background: #000; padding: 5px; border-radius: 4px; flex-shrink: 0; }
        .mg-cell { width: 25px; height: 25px; background: #222; display: flex; justify-content: center; align-items: center; font-size: 0.7rem; border-radius: 2px; color: #555; }
        
        .flow-text { flex: 1; line-height: 1.6; color: var(--text-dim); min-width: 250px; }
        .flow-text strong { color: white; }
        .logic-badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-weight: bold; font-size: 0.8rem; margin-right: 5px; color:black;}
        .lb-blue { background: var(--blue); } .lb-green { background: var(--green); } .lb-yell { background: var(--yellow); }
        
        .mg-click { border: 2px solid white; color: white; font-weight: bold; }
        .mg-x { background: #080808; color: #333; } .mg-x::after { content: "×"; }
        .mg-ok { background: rgba(255,255,255,0.05); border: 1px dashed #666; color: #aaa; }
        .mg-target { border: 2px dashed var(--gold); color: var(--gold); font-weight: bold; }
        
        .mg-blue { background: var(--blue); color: transparent; }
        .mg-green { background: var(--green); color: transparent; }
        .mg-yell { background: var(--yellow); color: transparent; }
        .mg-orng { background: var(--orange); color: transparent; }
        .mg-red { background: var(--red); color: transparent; }
        .mg-turq { background: var(--turquoise); color: transparent; }

        /* PANELES */
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; flex: 1; min-width: 300px; max-width: 100%; display: flex; flex-direction: column; align-items: center; }
        .dual-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        
        .btn-reset { width: 100%; padding: 12px; margin-top: 10px; background: var(--blue); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-red { background: var(--red); }
        
        /* SOLVER */
        .solver-palette { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; width: 100%; margin-bottom: 15px; }
        .p-btn { padding: 8px; border: 1px solid #333; cursor: pointer; color: white; font-size: 0.8rem; font-weight: bold; border-radius: 4px; text-align: center; }
        .p-btn.active { border-color: white; transform: scale(0.95); }
        .cell.eliminated { background: #000; opacity: 0.3; cursor: not-allowed; } .cell.eliminated::after { content: "×"; color: #555; font-size: 1.5rem; }
        .cell.candidate { box-shadow: inset 0 0 0 1px #fff; } .cell.candidate::after { content: "?"; color: rgba(255,255,255,0.3); }
        .cell.input-blue { background: var(--blue); border: 2px solid white; } .cell.input-green { background: var(--green); border: 2px solid white; }
        .cell.input-turquoise { background: var(--turquoise); border: 2px solid white; } .cell.input-yellow { background: var(--yellow); border: 2px solid white; }
        .cell.input-orange { background: var(--orange); border: 2px solid white; }
        .err-msg { color: var(--red); font-weight: bold; margin-bottom: 10px; height: 20px; text-align: center; opacity: 0; transition: opacity 0.2s;}

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body>

    <header>
        <div class="logo"><span>OUROCHEST</span>MASTER</div>
        <div class="controls">
            <button class="nav-btn active" onclick="navigate('practice')" data-key="nav_practice">Práctica</button>
            <button class="nav-btn" onclick="navigate('solver')" data-key="nav_solver">Solver</button>
            <button class="nav-btn" onclick="navigate('dual')" data-key="nav_dual">Dual</button>
            <button class="nav-btn" onclick="navigate('guide')" data-key="nav_guide">Guía</button>
            <select id="langSelect" onchange="manualLangChange(this.value)">
                <option value="es">Español</option>
                <option value="en">English</option>
            </select>
        </div>
    </header>

    <div id="main-container">
        
        <!-- VISTA PRÁCTICA -->
        <div id="view-practice" class="view-section active">
            <div class="panel">
                <h2 style="width:100%; display:flex; justify-content:space-between; color:white; margin-bottom:10px;">
                    <span data-key="practice_title">Práctica</span> 
                    <span id="p-score" style="color:var(--gold)">0 pts</span>
                </h2>
                <div style="width:100%; margin-bottom:10px; display:flex; gap:10px; font-size:0.9rem; color:#aaa;">
                    <label><input type="checkbox" id="hintToggle" onchange="toggleHints()" checked> <span data-key="lbl_hints">Pistas</span></label>
                </div>
                <div id="p-grid-container"></div>
                <div class="log-box" id="p-log"></div>
                <button class="btn-reset btn-red" onclick="resetPractice()" data-key="btn_restart">Reiniciar Partida</button>
            </div>
        </div>

        <!-- VISTA SOLVER -->
        <div id="view-solver" class="view-section">
            <div class="panel">
                <h2 style="width:100%; display:flex; justify-content:space-between; color:white; margin-bottom:10px;">
                    Solver <span id="s-status" style="font-size:0.8rem; opacity:0.7">24 Possible</span>
                </h2>
                <div id="s-error" class="err-msg">IMPOSSIBLE</div>
                <div class="solver-palette">
                    <div class="p-btn active" style="background:var(--blue)" onclick="setTool('blue')">BLUE</div>
                    <div class="p-btn" style="background:var(--green)" onclick="setTool('green')">GREEN</div>
                    <div class="p-btn" style="background:var(--turquoise)" onclick="setTool('turquoise')">TURQ</div>
                    <div class="p-btn" style="background:var(--yellow)" onclick="setTool('yellow')">YELL</div>
                    <div class="p-btn" style="background:var(--orange)" onclick="setTool('orange')">ORNG</div>
                    <div class="p-btn" style="background:#444" onclick="setTool('clear')">X</div>
                </div>
                <div id="s-grid-container"></div>
                <button class="btn-reset" onclick="resetSolver()" data-key="btn_clear">Limpiar</button>
            </div>
        </div>

        <!-- VISTA DUAL -->
        <div id="view-dual" class="view-section">
            <div class="dual-container">
                <div class="panel">
                    <h2 style="width:100%; display:flex; justify-content:space-between; color:white; margin-bottom:10px;">
                        <span data-key="practice_title">Game</span> <span id="d-p-score" style="color:var(--gold)">0</span>
                    </h2>
                    <div id="d-p-grid-container"></div>
                    <div class="log-box" id="d-p-log" style="height:250px"></div>
                    <button class="btn-reset btn-red" onclick="resetPractice()" data-key="btn_restart">Reiniciar</button>
                </div>
                <div class="panel">
                    <h2 style="width:100%; display:flex; justify-content:space-between; color:white; margin-bottom:10px;">
                        Solver <span id="d-s-status" style="font-size:0.8rem">24 OK</span>
                    </h2>
                    <div id="d-s-error" class="err-msg">ERROR</div>
                    <div class="solver-palette">
                         <div class="p-btn active" style="background:var(--blue)" onclick="setTool('blue')">BLUE</div>
                        <div class="p-btn" style="background:var(--green)" onclick="setTool('green')">GREEN</div>
                        <div class="p-btn" style="background:var(--turquoise)" onclick="setTool('turquoise')">TURQ</div>
                        <div class="p-btn" style="background:var(--yellow)" onclick="setTool('yellow')">YELL</div>
                        <div class="p-btn" style="background:var(--orange)" onclick="setTool('orange')">ORNG</div>
                        <div class="p-btn" style="background:#444" onclick="setTool('clear')">X</div>
                    </div>
                    <div id="d-s-grid-container"></div>
                    <button class="btn-reset" onclick="resetSolver()" data-key="btn_clear">Limpiar</button>
                </div>
            </div>
        </div>

        <!-- VISTA GUÍA -->
        <div id="view-guide" class="view-section">
            <div class="guide-container" id="guide-content">
                <!-- Inyectado por JS -->
            </div>
        </div>

    </div>

    <script>
        // ============================================
        // 1. SISTEMA DE IDIOMAS & GUÍA
        // ============================================
        
        const guideContent = {
            es: `
            <div class="guide-section">
                <div class="section-header">PASO 1: El Inicio (Obligatorio)</div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-click">1</div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    </div>
                    <div class="flow-text">
                        <p>Tu primer click <strong>SIEMPRE</strong> es el centro <strong>(3,3)</strong>.<br>
                        Como la roja nunca está ahí, este click nos revela información crucial sobre 4 ejes (filas, columnas y diagonales) de un solo golpe.</p>
                    </div>
                </div>
            </div>

            <div class="guide-section">
                <div class="section-header">RUTA A: El Centro es AZUL</div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell mg-x"></div>
                        <div class="mg-cell mg-ok">?</div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">?</div>
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-blue">1</div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div>
                        <div class="mg-cell mg-ok">?</div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">?</div>
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell mg-x"></div>
                    </div>
                    <div class="flow-text">
                        <p>Tenemos 8 candidatos. Hacemos click en <strong>(2,2)</strong>. Aunque sabemos que la roja NO está ahí, la usamos de "sonda".</p>
                    </div>
                </div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-blue">2</div><div class="mg-cell mg-x"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-blue">1</div><div class="mg-cell"></div><div class="mg-cell"></div>
                    </div>
                    <div class="flow-text">
                        <p>Si (2,2) es <span class="logic-badge lb-blue">AZUL</span>: Elimina la esquina superior izquierda. La roja debe estar en las otras zonas.<br>
                        Si (2,2) es <strong>NARANJA</strong>: La roja está en (1,2) o (2,1).</p>
                    </div>
                </div>
            </div>

            <div class="guide-section">
                <div class="section-header">RUTA B: El Centro es VERDE</div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">|</div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div>
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">|</div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div>
                        <div class="mg-cell mg-ok">-</div><div class="mg-cell mg-ok">-</div><div class="mg-cell mg-green">1</div><div class="mg-cell mg-ok">-</div><div class="mg-cell mg-ok">-</div>
                    </div>
                    <div class="flow-text">
                        <p>La roja está en la Cruz. Para saber si es vertical u horizontal, clickea en <strong>(2,2)</strong>.</p>
                    </div>
                </div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell mg-click mg-blue">2</div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-green">1</div><div class="mg-cell mg-target">!</div><div class="mg-cell mg-target">!</div>
                    </div>
                    <div class="flow-text">
                        <p>Si (2,2) sale <strong>AZUL</strong>, descartamos la columna vertical izquierda. Las opciones más probables son <strong>(3,4) y (3,5)</strong>.</p>
                    </div>
                </div>
            </div>

            <div class="guide-section">
                <div class="section-header">RUTA C: Centro AMARILLO (Esquinas)</div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-yell">1</div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell"></div>
                    </div>
                    <div class="flow-text">
                        <p>La roja es una de las 4 esquinas que tocan el centro.<br>
                        <strong>Paso 2:</strong> Clickea una de esas esquinas (ej. 2,2). Tienes 25% de acertar directo.</p>
                    </div>
                </div>
            </div>

            <div class="guide-section">
                <div class="section-header">RUTA D: Centro NARANJA (Vecinos)</div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell mg-orng">1</div><div class="mg-cell mg-ok">?</div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell"></div><div class="mg-cell"></div>
                    </div>
                    <div class="flow-text">
                        <p>La roja está pegada (Arriba, Abajo, Izq o Der).<br>
                        <strong>Paso 2:</strong> Elige un vecino (ej. Arriba, casilla 2,3). Si sale Naranja de nuevo, la tienes.</p>
                    </div>
                </div>
            </div>

            <div class="guide-section">
                <div class="section-header">RUTA E: Centro TURQUESA (Lejos)</div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell mg-ok">?</div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-ok">?</div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-turq">1</div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell mg-ok">?</div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-ok">?</div>
                    </div>
                    <div class="flow-text">
                        <p>La roja está en la misma diagonal, pero <strong>NO</strong> adyacente. Solo pueden ser las 4 esquinas extremas del tablero.<br>
                        <strong>Paso 2:</strong> Clickea una esquina extrema (1,1).</p>
                    </div>
                </div>
            </div>`,
            
            en: `
            <div class="guide-section">
                <div class="section-header">STEP 1: The Start</div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-click">1</div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                    </div>
                    <div class="flow-text">
                        <p>Your first click is <strong>ALWAYS</strong> the center <strong>(3,3)</strong>.<br>
                        Since Red is never there, this click reveals info about 4 axes at once.</p>
                    </div>
                </div>
            </div>

            <div class="guide-section">
                <div class="section-header">ROUTE A: Center is BLUE</div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell mg-x"></div>
                        <div class="mg-cell mg-ok">?</div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">?</div>
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-blue">1</div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div>
                        <div class="mg-cell mg-ok">?</div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">?</div>
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell mg-x"></div>
                    </div>
                    <div class="flow-text">
                        <p>We have 8 candidates. Click on <strong>(2,2)</strong>. Even if we know Red is NOT there, we use it as a probe.</p>
                    </div>
                </div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-blue">2</div><div class="mg-cell mg-x"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-blue">1</div><div class="mg-cell"></div><div class="mg-cell"></div>
                    </div>
                    <div class="flow-text">
                        <p>If (2,2) is <span class="logic-badge lb-blue">BLUE</span>: Eliminates top-left corner. Red must be elsewhere.<br>
                        If (2,2) is <strong>ORANGE</strong>: Red is at (1,2) or (2,1).</p>
                    </div>
                </div>
            </div>

            <div class="guide-section">
                <div class="section-header">ROUTE B: Center is GREEN</div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">|</div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div>
                        <div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div><div class="mg-cell mg-ok">|</div><div class="mg-cell mg-x"></div><div class="mg-cell mg-x"></div>
                        <div class="mg-cell mg-ok">-</div><div class="mg-cell mg-ok">-</div><div class="mg-cell mg-green">1</div><div class="mg-cell mg-ok">-</div><div class="mg-cell mg-ok">-</div>
                    </div>
                    <div class="flow-text">
                        <p>Red is in the Cross (+). To verify axis, click <strong>(2,2)</strong>.</p>
                    </div>
                </div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell mg-click mg-blue">2</div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-green">1</div><div class="mg-cell mg-target">!</div><div class="mg-cell mg-target">!</div>
                    </div>
                    <div class="flow-text">
                        <p>If (2,2) is <strong>BLUE</strong>, we discard the vertical column. Most probable options are <strong>(3,4) and (3,5)</strong>.</p>
                    </div>
                </div>
            </div>

            <div class="guide-section">
                <div class="section-header">ROUTE C: Center is YELLOW</div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-yell">1</div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell"></div>
                    </div>
                    <div class="flow-text">
                        <p>Red is in one of the 4 touching corners.<br>
                        <strong>Step 2:</strong> Click one of them (e.g. 2,2). 25% chance to hit.</p>
                    </div>
                </div>
            </div>

            <div class="guide-section">
                <div class="section-header">ROUTE D: Center is ORANGE</div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell mg-orng">1</div><div class="mg-cell mg-ok">?</div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-ok">?</div><div class="mg-cell"></div><div class="mg-cell"></div>
                    </div>
                    <div class="flow-text">
                        <p>Red is adjacent (Up, Down, Left, Right).<br>
                        <strong>Step 2:</strong> Pick a neighbor (e.g. Up, cell 2,3).</p>
                    </div>
                </div>
            </div>

            <div class="guide-section">
                <div class="section-header">ROUTE E: Center is TURQUOISE</div>
                <div class="flow-step">
                    <div class="mini-grid">
                        <div class="mg-cell mg-ok">?</div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-ok">?</div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-turq">1</div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div>
                        <div class="mg-cell mg-ok">?</div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell"></div><div class="mg-cell mg-ok">?</div>
                    </div>
                    <div class="flow-text">
                        <p>Red is in same diagonal but NOT adjacent. Only 4 far corners possible.<br>
                        <strong>Step 2:</strong> Click a far corner (1,1).</p>
                    </div>
                </div>
            </div>`
        };

        const translations = {
            es: {
                nav_practice: "Práctica", nav_solver: "Solver", nav_dual: "Dual", nav_guide: "Guía",
                practice_title: "Práctica", lbl_hints: "Pistas", btn_restart: "Reiniciar Partida", btn_clear: "Limpiar Todo",
                colors: { blue: "AZUL", green: "VERDE", turquoise: "TURQ.", yellow: "AMARILLA", orange: "NARANJA", red: "ROJA" },
                hints: {
                    blue: "Elimina Fila, Col y Diagonales.", green: "Está en Fila o Columna.", turquoise: "Está en Diagonal.",
                    yellow: "Esquina adyacente.", orange: "Adyacente (Arriba/Abajo/Izq/Der).", red: "¡ENCONTRADA!"
                },
                msgs: { start: "Inicia clickeando el centro (3,3).", summary: "RESUMEN FINAL" }
            },
            en: {
                nav_practice: "Practice", nav_solver: "Solver", nav_dual: "Dual", nav_guide: "Guide",
                practice_title: "Practice", lbl_hints: "Hints", btn_restart: "Restart Game", btn_clear: "Clear All",
                colors: { blue: "BLUE", green: "GREEN", turquoise: "TURQ.", yellow: "YELLOW", orange: "ORANGE", red: "RED" },
                hints: {
                    blue: "Kills Row, Col & Diagonals.", green: "In Row or Column.", turquoise: "In Diagonal.",
                    yellow: "Adjacent Corner.", orange: "Adjacent (Up/Down/Left/Right).", red: "FOUND!"
                },
                msgs: { start: "Start by clicking center (3,3).", summary: "FINAL SCORE" }
            }
        };

        let curLang = 'es';
        let currentView = 'practice';

        // DETECCIÓN AUTOMÁTICA DE IDIOMA
        function autoDetectLanguage() {
            const userLang = navigator.language || navigator.userLanguage; 
            return userLang.startsWith('es') ? 'es' : 'en';
        }

        function setLanguage(lang) {
            curLang = lang;
            document.getElementById('langSelect').value = lang;
            
            const t = translations[curLang];
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if(t[key]) el.innerText = t[key];
            });
            document.getElementById('guide-content').innerHTML = guideContent[curLang];
            renderLog();
        }

        // ENRUTAMIENTO (HASH ROUTING)
        function updateURL() {
            window.location.hash = `${curLang}/${currentView}`;
        }

        function readURL() {
            const hash = window.location.hash.substring(1); // remove #
            if (!hash) {
                // Primer acceso: Autodetectar
                const detected = autoDetectLanguage();
                setLanguage(detected);
                navigate('practice'); // Default view
                return;
            }

            const parts = hash.split('/');
            if (parts.length === 2) {
                const lang = parts[0];
                const view = parts[1];
                if (translations[lang]) setLanguage(lang);
                if (['practice','solver','dual','guide'].includes(view)) navigate(view, false);
            }
        }

        function navigate(viewName, updateHistory = true) {
            currentView = viewName;
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+viewName).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-btn[onclick*="'${viewName}'"]`).classList.add('active');

            if(viewName==='practice' || viewName==='dual') {
                if(pState.clicks===0 && pState.history.length===0) resetPractice();
            }
            if (updateHistory) updateURL();
        }

        function manualLangChange(val) {
            setLanguage(val);
            updateURL();
        }

        // Event Listeners
        window.addEventListener('hashchange', readURL);
        window.addEventListener('load', readURL);

        // ============================================
        // 2. GRID & LOGIC
        // ============================================
        function createGridHTML(prefix, isSolver = false) {
            let html = '<div class="grid-wrapper">';
            html += '<div class="coord-header"></div>';
            for(let i=1; i<=5; i++) html += `<div class="coord-header">${i}</div>`;
            for(let r=0; r<5; r++) {
                html += `<div class="coord-header">${r+1}</div>`;
                for(let c=0; c<5; c++) {
                    let onclick = isSolver ? `solverClick(${r},${c})` : `practiceClick(${r},${c})`;
                    let id = `${prefix}-cell-${r}-${c}`;
                    html += `<div id="${id}" class="cell ${isSolver?'candidate':''}" onclick="${onclick}"></div>`;
                }
            }
            html += '</div>';
            return html;
        }

        document.getElementById('p-grid-container').innerHTML = createGridHTML('p');
        document.getElementById('s-grid-container').innerHTML = createGridHTML('s', true);
        document.getElementById('d-p-grid-container').innerHTML = createGridHTML('d-p');
        document.getElementById('d-s-grid-container').innerHTML = createGridHTML('d-s', true);

        // ============================================
        // 3. PRÁCTICA
        // ============================================
        let pState = { red: {r:0,c:0}, clicks:0, score:0, history:[], done:false, hints:true };

        function toggleHints() {
            pState.hints = document.getElementById('hintToggle').checked;
            renderLog();
        }

        function resetPractice() {
            do { pState.red.r = Math.floor(Math.random()*5); pState.red.c = Math.floor(Math.random()*5); } 
            while(pState.red.r===2 && pState.red.c===2);
            pState.clicks = 0; pState.score = 0; pState.history = []; pState.done = false;
            pState.hints = document.getElementById('hintToggle').checked;
            renderPracticeState();
            renderLog();
        }

        function practiceClick(r, c) {
            if(pState.done || pState.clicks>=5) return;
            if(pState.history.find(h=>h.r===r && h.c===c)) return;

            pState.clicks++;
            let color = getDistanceColor(pState.red.r, pState.red.c, r, c);
            let pts = (color==='red')?150 : (color==='orange')?90 : (color==='yellow')?55 : (color==='green'||color==='turquoise')?20 : 10;
            pState.score += pts;
            pState.history.push({r,c,color,pts});
            
            if(pState.clicks>=5) pState.done = true;

            renderPracticeState();
            addLogEntry(color, {r,c}, pts);

            if(pState.done) addLogSummary();
        }

        function renderPracticeState() {
            ['p','d-p'].forEach(pre => {
                let sc = document.getElementById(pre+'-score');
                if(sc) sc.innerText = pState.score + ' pts';
                
                for(let r=0; r<5; r++) for(let c=0; c<5; c++) {
                    let cell = document.getElementById(`${pre}-cell-${r}-${c}`);
                    cell.className = 'cell'; cell.innerText = ''; cell.style.opacity = '1';
                }
                
                pState.history.forEach(h => {
                    let cell = document.getElementById(`${pre}-cell-${h.r}-${h.c}`);
                    cell.classList.add('revealed', h.color);
                });

                if(pState.done) {
                    let rCell = document.getElementById(`${pre}-cell-${pState.red.r}-${pState.red.c}`);
                    if(!rCell.classList.contains('revealed')) {
                        rCell.classList.add('revealed', 'red'); rCell.style.opacity = '0.5';
                    }
                }
            });
        }

        function renderLog() {
            ['p-log','d-p-log'].forEach(id => {
                const el = document.getElementById(id); el.innerHTML = '';
                addLogHTML(el, 'start', null, 0);
                pState.history.forEach(h => addLogHTML(el, h.color, h, h.pts));
                if(pState.done) addLogHTML(el, 'summary', null, pState.score);
            });
        }

        function addLogEntry(type, coords, pts) {
            ['p-log', 'd-p-log'].forEach(id => addLogHTML(document.getElementById(id), type, coords, pts));
        }
        function addLogSummary() {
            ['p-log', 'd-p-log'].forEach(id => addLogHTML(document.getElementById(id), 'summary', null, pState.score));
        }

        function addLogHTML(el, type, coords, pts) {
            const t = translations[curLang];
            if (type === 'summary') {
                el.insertAdjacentHTML('beforeend', `<div class="summary-card"><div style="font-size:0.9rem; opacity:0.8">${t.msgs.summary}</div><div style="font-size:2rem; font-weight:bold; color:var(--gold)">${pts}</div></div>`);
                el.scrollTop = el.scrollHeight; return;
            }

            let title = (type==='start') ? "" : t.colors[type];
            let desc = "";
            if(type==='start') desc = t.msgs.start;
            else if(pState.hints) desc = t.hints[type] || "";

            let css = '';
            if(type==='blue') css='le-blue'; else if(type==='green') css='le-green';
            else if(type==='turquoise') css='le-turq'; else if(type==='yellow') css='le-yell';
            else if(type==='orange') css='le-orng'; else if(type==='red') css='le-red';
            
            let html = `
                <div class="log-entry ${css}">
                    <div class="log-num">${coords ? pState.history.findIndex(h=>h===coords)+1 : '#'}</div>
                    <div class="log-desc">
                        ${title ? `<strong>${title}</strong>` : ''} 
                        ${coords ? `(${coords.r+1},${coords.c+1})` : ''}
                        ${desc ? `<span class="hint-text">${desc}</span>` : ''}
                    </div>
                    ${pts>0 ? `<div class="log-pts">+${pts}</div>` : ''}
                </div>`;
            el.insertAdjacentHTML('beforeend', html);
            el.scrollTop = el.scrollHeight;
        }

        function getDistanceColor(rRed, cRed, r, c) {
            let dr = Math.abs(rRed - r), dc = Math.abs(cRed - c);
            if(dr===0 && dc===0) return 'red';
            if((dr===0 && dc===1) || (dr===1 && dc===0)) return 'orange';
            if(dr===1 && dc===1) return 'yellow';
            if(dr===0 || dc===0) return 'green';
            if(dr===dc) return 'turquoise';
            return 'blue';
        }

        // ============================================
        // 4. SOLVER
        // ============================================
        let sState = { tool: 'blue', inputs: Array(5).fill().map(()=>Array(5).fill(null)) };

        function setTool(t) {
            sState.tool = t;
            document.querySelectorAll('.p-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll(`.p-btn[onclick*="'${t}'"]`).forEach(b => b.classList.add('active'));
        }

        function solverClick(r, c) {
            let nextInputs = sState.inputs.map(row => [...row]);
            let newVal = (sState.tool==='clear') ? null : sState.tool;
            nextInputs[r][c] = newVal;
            if(newVal !== null) {
                if(calculatePossibilities(nextInputs) === 0) {
                    showError("ERROR: IMPOSSIBLE");
                    ['s','d-s'].forEach(pre => {
                        let cell = document.getElementById(`${pre}-cell-${r}-${c}`);
                        cell.classList.add('shake'); setTimeout(() => cell.classList.remove('shake'), 400);
                    });
                    return;
                }
            }
            sState.inputs = nextInputs;
            renderSolver();
        }

        function resetSolver() { sState.inputs = Array(5).fill().map(()=>Array(5).fill(null)); renderSolver(); }

        function calculatePossibilities(inputs) {
            let count = 0;
            for(let r=0; r<5; r++) for(let c=0; c<5; c++) {
                if(r===2 && c===2) continue;
                let ok = true;
                for(let ir=0; ir<5; ir++) for(let ic=0; ic<5; ic++) {
                    let input = inputs[ir][ic];
                    if(input && getDistanceColor(r,c,ir,ic) !== input) { ok=false; break; }
                }
                if(ok) count++;
            }
            return count;
        }

        function renderSolver() {
            let possible = 0; let matrix = [];
            for(let r=0; r<5; r++) {
                matrix[r] = [];
                for(let c=0; c<5; c++) {
                    if(r===2 && c===2) { matrix[r][c]=false; continue; }
                    let ok = true;
                    for(let ir=0; ir<5; ir++) for(let ic=0; ic<5; ic++) {
                        let input = sState.inputs[ir][ic];
                        if(input && getDistanceColor(r,c,ir,ic) !== input) { ok=false; break; }
                    }
                    matrix[r][c] = ok;
                    if(ok) possible++;
                }
            }
            document.getElementById('s-status').innerText = `${possible} Possible`;
            document.getElementById('d-s-status').innerText = `${possible} OK`;
            ['s','d-s'].forEach(pre => {
                for(let r=0; r<5; r++) for(let c=0; c<5; c++) {
                    let cell = document.getElementById(`${pre}-cell-${r}-${c}`);
                    cell.className = 'cell';
                    let input = sState.inputs[r][c];
                    if(input) cell.classList.add('input-'+input);
                    else if(matrix[r][c]) cell.classList.add('candidate');
                    else cell.classList.add('eliminated');
                }
            });
        }

        function showError(msg) {
            ['s-error', 'd-s-error'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.innerText = msg; el.style.opacity = 1; setTimeout(()=>el.style.opacity=0, 1000); }
            });
        }

        // Init
        resetPractice();
        resetSolver();

    </script>
</body>
</html>
